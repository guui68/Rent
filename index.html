<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>প্রিমিয়াম ভাড়ার রশিদ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --main: #1a2a6c; --text: #333; --border-color: #000; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #e9ecef; display: flex; flex-direction: column; align-items: center; padding: 15px; }
        
        .receipt-container { 
            width: 100%; max-width: 450px; background: #fff; padding: 30px; 
            border-radius: 5px; box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            border-top: 15px solid var(--main); position: relative;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 28px; color: var(--main); letter-spacing: 2px; }

        .info-box div { display: flex; margin-bottom: 8px; border-bottom: 2px solid #555; padding-bottom: 3px; }
        .info-box label { font-weight: bold; width: 110px; color: #000; }
        input { border: none; outline: none; width: 100%; font-family: inherit; font-size: 15px; background: transparent; }

        .add-btn { background: #f1f3f5; color: var(--main); border: 1px dashed var(--main); padding: 8px; width: 100%; margin-bottom: 15px; cursor: pointer; font-weight: bold; }

        table { width: 100%; border-collapse: collapse; border: 2px solid var(--main); }
        th { background: var(--main); color: #fff; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1.5px solid var(--border-color); position: relative; }
        
        .amt-col { text-align: right; font-weight: bold; width: 120px; }
        .reading-text { font-size: 11px; color: #0047ab; font-weight: 800; position: absolute; left: 10px; bottom: 2px; pointer-events: none; }
        #calc-link { color: blue; cursor: pointer; display: block; font-size: 10px; font-weight: bold; }

        .del-btn { position: absolute; left: -25px; top: 50%; transform: translateY(-50%); color: red; border: none; background: none; cursor: pointer; font-weight: bold; }

        .total-box { margin-top: 15px; padding: 15px; background: #f8f9fa; border-left: 8px solid var(--main); border-bottom: 2px solid #000; display: flex; justify-content: space-between; align-items: center; }
        .in-word-box { width: 100%; margin-top: 10px; font-size: 18px; color: #000; font-weight: 900; text-align: left; }

        /* পপআপ ডিজাইন */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; }
        .modal-card { background: #fff; padding: 25px; border-radius: 12px; width: 300px; border-top: 10px solid var(--main); box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-card input { border: 1px solid #ddd; padding: 10px; border-radius: 5px; margin-top: 5px; width: 93%; background: #f9f9f9; font-size: 16px; }
        
        .btn-group { width: 100%; max-width: 450px; margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .btn { flex: 1; min-width: 100px; padding: 12px; border: none; border-radius: 5px; font-weight: bold; color: #fff; cursor: pointer; font-size: 14px; }
        .btn-save { background: var(--main); color: #fff; border: none; padding: 12px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 15px; }

        .hide-for-capture { display: none !important; }
        .editable-label { width: 100%; border: none; outline: none; background: transparent; cursor: pointer; }
    </style>
</head>
<body>

<div class="receipt-container" id="receipt">
    <div class="header"><h1>ভাড়ার রশিদ</h1></div>

    <div class="info-box">
        <div><label>তারিখঃ</label> <input type="text" id="date-input" placeholder="১৫/০২/২০২৬" ondblclick="setToday()"></div>
        <div><label>বাড়িয়ালাঃ</label> <input type="text" placeholder="নাম লিখুন"></div>
        <div><label>রুম নংঃ</label> <input type="text" id="room-input" placeholder="১০২"></div>
        <div><label>ভাড়াটিয়াঃ</label> <input type="text" id="tenant-input" placeholder="নাম লিখুন"></div>
    </div>

    <button class="add-btn capture-hide" onclick="addNewRow()">+ নতুন আইটেম যোগ করুন</button>

    <table>
        <thead><tr><th>বিবরণ</th><th style="text-align: right;">টাকা (৳)</th></tr></thead>
        <tbody id="items-table">
            <tr class="item-row"><td>মাসিক ভাড়া</td><td class="amt-col"><input type="number" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right;"></td></tr>
            <tr class="item-row">
                <td>বিদ্যুৎ বিল <small id="calc-link" class="capture-hide" onclick="openElecModal()">(ক্যালকুলেটর)</small></td>
                <td class="amt-col">
                    <input type="number" id="elec-val" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="checkType()" value="0" style="text-align: right; width: 100%;">
                    <div id="ebill-info" class="reading-text"></div>
                </td>
            </tr>
            <tr class="item-row"><td>WIFI বিল</td><td class="amt-col"><input type="number" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right;"></td></tr>
            <tr class="item-row"><td>আগের বকেয়া</td><td class="amt-col"><input type="number" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right;"></td></tr>
            <tr class="item-row"><td>হাওলাত</td><td class="amt-col"><input type="number" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right;"></td></tr>
            <tr class="item-row"><td>অন্যান্য</td><td class="amt-col"><input type="number" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right;"></td></tr>
        </tbody>
        <tfoot>
            <tr class="item-row" style="background: #fff5f5;">
                <td style="color: #d32f2f; font-weight: bold;">(-) জমা</td>
                <td class="amt-col"><input type="number" id="joma" class="minus" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right; color: #d32f2f;"></td>
            </tr>
        </tfoot>
    </table>

    <div class="total-box">
        <span>মোট পাওনাঃ</span>
        <h2 id="total-text">0 ৳</h2>
    </div>
    <div class="in-word-box" id="in-word-text">কথায়: শূন্য টাকা মাত্র</div>
</div>

<div class="modal" id="modal-elec">
    <div class="modal-card">
        <h3 style="text-align:center; color:var(--main);">ইউনিট হিসাব</h3>
        <label>বর্তমান (V)</label><input type="number" id="curr" placeholder="0" oninput="liveCalc()">
        <label>পূর্বের (P)</label><input type="number" id="prev" placeholder="0" oninput="liveCalc()">
        <label>রেট (৳)</label><input type="number" id="rate" value="10" oninput="liveCalc()">
        <div style="background:#f0f4ff; margin-top:15px; padding:10px; border-radius:5px; text-align:center; font-weight:bold;">
            U: <span id="u-res">0</span> | বিল: <span id="b-res">0</span> ৳
        </div>
        <button class="btn-save" onclick="saveElec()">সেভ করুন</button>
        <p onclick="closeModal('modal-elec')" style="text-align:center; color:red; cursor:pointer; margin-top:10px;">বন্ধ করুন</p>
    </div>
</div>

<div class="modal" id="modal-names">
    <div class="modal-card">
        <h3>বিবরণ সিলেক্ট করুন</h3>
        <select id="name-selector" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="গ্যাস বিল">গ্যাস বিল</option>
            <option value="ফ্রিজ বিল">ফ্রিজ বিল</option>
            <option value="ময়লা বিল">ময়লা বিল</option>
            <option value="পানি বিল">পানি বিল</option>
            <option value="গ্যারেজ বিল">গ্যারেজ বিল</option>
            <option value="সার্ভিস চার্জ">সার্ভিস চার্জ</option>
        </select>
        <button class="btn-save" onclick="applyName()">ওকে</button>
    </div>
</div>

<div class="btn-group">
    <button class="btn" style="background:#333;" onclick="process('download')">ছবি</button>
    <button class="btn" style="background:#dc3545;" onclick="process('pdf')">পিডিএফ</button>
    <button class="btn" style="background:#25D366;" onclick="process('share')">শেয়ার</button>
</div>

<script>
    let activeInput = null;

    function clearZero(el) { if(el.value == "0") el.value = ""; }
    function resetZero(el) { if(el.value == "") el.value = "0"; }

    function setToday() {
        const t = new Date();
        document.getElementById('date-input').value = `${String(t.getDate()).padStart(2,'0')}/${String(t.getMonth()+1).padStart(2,'0')}/${t.getFullYear()}`;
    }

    function addNewRow() {
        const table = document.getElementById('items-table');
        const row = document.createElement('tr');
        row.className = 'item-row';
        row.innerHTML = `
            <td>
                <button class="del-btn capture-hide" onclick="this.parentElement.parentElement.remove(); calc();">×</button>
                <input type="text" class="editable-label" value="নতুন আইটেম" ondblclick="openNameModal(this)" readonly>
            </td>
            <td class="amt-col"><input type="number" class="fee" onfocus="clearZero(this)" onblur="resetZero(this)" oninput="calc()" value="0" style="text-align: right;"></td>
        `;
        table.appendChild(row);
    }

    function openNameModal(input) { activeInput = input; document.getElementById('modal-names').style.display = 'flex'; }
    function applyName() { if(activeInput) activeInput.value = document.getElementById('name-selector').value; closeModal('modal-names'); }
    function openElecModal() { document.getElementById('modal-elec').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function liveCalc() {
        let c = parseFloat(document.getElementById('curr').value) || 0;
        let p = parseFloat(document.getElementById('prev').value) || 0;
        let r = parseFloat(document.getElementById('rate').value) || 0;
        let u = c - p;
        document.getElementById('u-res').innerText = u > 0 ? u : 0;
        document.getElementById('b-res').innerText = u > 0 ? (u * r) : 0;
    }

    function saveElec() {
        document.getElementById('elec-val').value = document.getElementById('b-res').innerText;
        document.getElementById('ebill-info').innerText = `V=${document.getElementById('curr').value || 0} P=${document.getElementById('prev').value || 0} U=${document.getElementById('u-res').innerText}`;
        closeModal('modal-elec'); calc();
    }

    function checkType() { document.getElementById('ebill-info').innerText = ""; calc(); }

    function calc() {
        let total = 0;
        document.querySelectorAll('.fee').forEach(f => total += parseFloat(f.value) || 0);
        let grand = total - (parseFloat(document.getElementById('joma').value) || 0);
        document.getElementById('total-text').innerText = grand + " ৳";
        document.getElementById('in-word-text').innerText = "কথায়: " + bnAmount(grand) + " টাকা মাত্র";
    }

    function bnAmount(n) {
        if (n <= 0) return "শূন্য";
        const units = ['', 'এক', 'দুই', 'তিন', 'চার', 'পাঁচ', 'ছয়', 'সাত', 'আট', 'নয়'];
        const teens = ['দশ', 'এগারো', 'বারো', 'তেরো', 'চৌদ্দ', 'পনেরো', 'ষোলো', 'সতেরো', 'আঠারো', 'উনিশ'];
        const tens = ['', '', 'বিশ', 'ত্রিশ', 'চল্লিশ', 'পঞ্চাশ', 'ষাট', 'সত্তর', 'আশি', 'নব্বই'];
        function conv(num) {
            if (num < 10) return units[num];
            if (num < 20) return teens[num-10];
            if (num < 100) return tens[Math.floor(num/10)] + (num%10!==0?" "+units[num%10]:"");
            if (num < 1000) return units[Math.floor(num/100)] + " শত " + (num%100!==0?conv(num%100):"");
            if (num < 100000) return conv(Math.floor(num/1000)) + " হাজার " + (num%1000!==0?conv(num%1000):"");
            return conv(Math.floor(num/100000)) + " লক্ষ " + (num%100000!==0?conv(num%100000):"");
        }
        return conv(n);
    }

    async function process(mode) {
        const tenant = document.getElementById('tenant-input').value || "ভাড়াটিয়া";
        const room = document.getElementById('room-input').value || "রুম";
        const fileName = `${tenant}_${room}`;

        // হাইড করা এবং জিরো ঘর বাদ দেওয়া
        document.querySelectorAll('.capture-hide, .del-btn, .add-btn').forEach(el => el.classList.add('hide-for-capture'));
        document.querySelectorAll('.item-row').forEach(row => { 
            let val = parseFloat(row.querySelector('input[type="number"]')?.value) || 0;
            if(val === 0 && !row.innerHTML.includes('joma')) row.classList.add('hide-for-capture'); 
        });

        const canvas = await html2canvas(document.getElementById('receipt'), { scale: 3, backgroundColor: "#ffffff" });
        document.querySelectorAll('.hide-for-capture').forEach(el => el.classList.remove('hide-for-capture'));

        if (mode === 'pdf') {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 190; // A4 এর সাথে মানানসই সাইজ
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
            pdf.save(fileName + ".pdf");
        } else if (mode === 'download') {
            const link = document.createElement('a');
            link.download = fileName + ".png";
            link.href = canvas.toDataURL();
            link.click();
        } else if (mode === 'share') {
            canvas.toBlob(b => navigator.share({files:[new File([b], fileName + ".png", {type:"image/png"})]}));
        }
    }
</script>
</body>
</html>
